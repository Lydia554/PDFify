<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF API Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  </head>
  <body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
    <header class="p-4 bg-blue-700 text-white text-center text-2xl font-semibold">
      üßæ PDF API Dashboard
    </header>

    <main class="flex-grow p-4">
      <div class="flex justify-center space-x-4 mb-6">
        <button id="developerModeBtn" class="px-4 py-2 border rounded hover:bg-blue-100">üíª Developer Mode</button>
        <button id="friendlyModeBtn" class="px-4 py-2 border rounded hover:bg-green-100">üåº Friendly Mode</button>
      </div>

      <section id="developerMode" style="display: block;">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-4xl mx-auto">
          <label class="block mb-2">üîë API Key</label>
          <input type="text" id="apiKey" class="w-full border p-3 rounded mb-4" />

          <label class="block mb-2">üì§ Endpoint</label>
          <select id="endpoint" class="w-full border p-3 rounded mb-4">
            <option value="orders">Orders</option>
            <option value="invoices">Invoices</option>
          </select>

          <label class="block mb-2">üìù JSON Data</label>
          <textarea id="json" rows="10" class="w-full p-3 border rounded mb-4"></textarea>

          <div class="flex flex-wrap gap-4">
            <button id="previewDevBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded">üîç Preview</button>
            <button id="generateDevBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">üì• Generate PDF</button>
          </div>
        </div>
        <p id="result" class="text-center mt-4 text-red-600"></p>
      </section>

      <section id="friendlyMode" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-4xl mx-auto">
          <label class="block mb-2 friendly-label">üîë API Key</label>
          <input type="text" class="w-full border p-4 text-lg rounded mb-6" placeholder="Paste your API key here" />

          <label class="block mb-2 friendly-label">üìÑ Choose PDF Type</label>
          <select class="w-full border p-4 text-lg rounded mb-6">
            <option>üßæ Invoice</option>
            <option>üì¶ Order Summary</option>
          </select>

          <label class="block mb-2 friendly-label">üìã Fill in your data</label>
          <textarea rows="8" class="w-full border p-4 text-lg rounded mb-6" placeholder='e.g. { "name": "John Doe", "order": 12345 }'></textarea>

          <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded w-full text-lg">üöÄ Generate PDF</button>
        </div>
      </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-auto">
      &copy; 2025 Food Trek PDF Generator API
    </footer>

    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50" style="display:none">
      <div class="text-xl font-semibold">‚è≥ Loading...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/script.js"></script>

  <script type="module" src="scripts-friendly-mode/frontend-friendly-mode.js"></script>

  <script src="/js/previewFriendlyMode.js"></script>



  <script >
const devBtn = document.getElementById('developerModeBtn');
const friendlyBtn = document.getElementById('friendlyModeBtn');
const devSection = document.getElementById('developerMode');
const friendlySection = document.getElementById('friendlyMode');

devBtn.addEventListener('click', () => {
  devBtn.classList.add('active');
  friendlyBtn.classList.remove('active');
  devSection.style.display = 'block';
  friendlySection.style.display = 'none';
});

friendlyBtn.addEventListener('click', () => {
  friendlyBtn.classList.add('active');
  devBtn.classList.remove('active');
  devSection.style.display = 'none';
  friendlySection.style.display = 'block';




  
});

    document.querySelectorAll("nav a").forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const targetUrl = event.target.href;
    
        const loadingOverlay = document.getElementById("loadingOverlay");
        loadingOverlay.style.display = "flex";
        console.log("Spinner shown");
    
        if (!targetUrl) {
          console.error("Invalid target URL");
          loadingOverlay.style.display = "none";
          return;
        }
    
        setTimeout(() => {
          console.log("Navigating to:", targetUrl);
          window.location.href = targetUrl;
        }, 500);
      });
    });
    
    window.addEventListener("load", () => {
      const loadingOverlay = document.getElementById("loadingOverlay");
      loadingOverlay.style.display = "none";
      console.log("Spinner hidden on page load");
    });
    
    async function sendRequest() {
      showProgressBar();
    
      try {
        await new Promise((resolve) => setTimeout(resolve, 2000));
        alert("Request completed!");
      } catch (error) {
        console.error("Error:", error);
      } finally {
        setTimeout(hideProgressBar, 500);
      }
    }
    
    async function fetchUserUsage() {
      const apiKey = localStorage.getItem("apiKey");
      if (!apiKey) {
        alert("No API key found. Please log in.");
        window.location.href = "/login.html";
        return;
      }
    
      try {
  const response = await axios.get(`/api/user/usage`, {
    headers: { Authorization: `Bearer ${apiKey}` },
  });

  const { usageCount, maxUsage } = response.data;

    
        if (usageCount >= maxUsage) {
          document.getElementById("result").innerText = "Monthly usage limit reached. Upgrade to premium for unlimited access.";
          document.querySelector("button[onclick='sendRequest()']").disabled = true;
        }
      } catch (error) {
        console.error("Error fetching user usage:", error);
      }
    }
    
    fetchUserUsage();
    function updateJsonForEndpoint(endpoint) {
      const baseUrl = window.location.origin;

  let jsonData = "";
if (endpoint === "generate-recipe") {
  jsonData = `{
    "data": {
      "recipeName": "Cheese Pie",
      "author": "Anna Moore",
      "ingredients": [
        "500g flour",
        "200g cheese",
        "100g butter",
        "1 egg"
      ],
      "instructions": [
        "Mix the flour, egg, and butter.",
        "Add crumbled cheese.",
        "Bake in preheated oven at 180¬∞C for 40 minutes."
      ],
      "prepTime": "30 minutes",
      "cookTime": "40 minutes",
      "ingredientBreakdown": {
        "Flour": 500,
        "Cheese": 200,
        "Butter": 100,
        "Egg": 1
      }
    }
  }`;


  } else if (endpoint === "generate-therapy-report") {
    jsonData = `{
      "data": {
        "childName": "Anna Moore",
        "birthDate": "2021-02-14",
        "sessionDate": "2025-03-25",
        "therapyType": "Speech Therapy",
        "observations": "The child shows progress in articulating sounds.",
        "recommendations": "Continue home exercises for 10 minutes daily. Next check-up in 4 weeks.",
        "milestones": [
          { "name": "Pronounce B", "progress": "Improved" },
          { "name": "Pronounce M", "progress": "Satisfactory" },
          { "name": "Pronounce P", "progress": "Excellent" }
        ],
        "milestonesData": [60, 70, 90],
        "logoUrl": "${baseUrl}/images/Logo.png"
      }
    }`;

  } else if (endpoint === "generate-shop-order") {
    jsonData = `{
      "data": {
        "shopName": "TetaFit Store",
        "customer": {
          "name": "Anna Moore",
          "email": "anna@example.com"
        },
        "orderId": "ORD-98765",
        "date": "2025-03-25",
        "products": [
          { "name": "Protein Bar", "quantity": 2, "price": "4.00‚Ç¨" },
          { "name": "Yoga Mat", "quantity": 1, "price": "19.99‚Ç¨" }
        ],
        "total": "27.99‚Ç¨"
      }
    }`;

  } else if (endpoint === "generate-invoice") {
  jsonData = `{
    "data": {
      "customerName": "Anna Moore",
      "customerEmail": "anna@example.com",
      "orderId": "12345",
      "date": "2025-03-25",
      "items": [
        { "name": "PDF Template", "quantity": 1, "price": "10.00‚Ç¨", "total": "10.00" },
        { "name": "Extra Support", "quantity": 1, "price": "5.00‚Ç¨", "total": "5.00" }
      ],
      "subtotal": "15.00‚Ç¨",
      "tax": "3.15‚Ç¨",
      "total": "18.15‚Ç¨",
      "customLogoUrl": "https://example.com/custom-logo.png", 
      "showChart": false,
      "isPremium": false
    }
  }`;
    
  } else if (endpoint === "generate-packing-slip") {
      jsonData = `{
        "data": {
          "orderId": "98765",
          "customerName": "John Smith",
          "shippingAddress": "1234 Maple Street, Springfield, USA",
          "date": "2025-05-14",
          "items": [
            { "name": "Yoga Mat", "sku": "YM-001", "quantity": 1 },
            { "name": "Dumbbells Set", "sku": "DB-002", "quantity": 2 },
            { "name": "Water Bottle", "sku": "WB-003", "quantity": 3 }
          ]
        }
      }`;
      

  } else if (endpoint === "generate-pdf-from-html") {
  jsonData = JSON.stringify({
    html: `
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #333; text-align: center; }
            p { line-height: 1.6; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f4f7fb; }
          </style>
        </head>
        <body>
          <h1>Sample Raw HTML</h1>
          <p>This is a sample PDF generated from raw HTML.</p>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Quantity</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Sample Item 1</td>
                <td>2</td>
                <td>$10.00</td>
              </tr>
              <tr>
                <td>Sample Item 2</td>
                <td>1</td>
                <td>$5.00</td>
              </tr>
            </tbody>
          </table>
        </body>
      </html>
    `

    }, null, 2);
  }


      document.getElementById('json').value = jsonData;
    }
    
    document.getElementById('endpoint').addEventListener('change', (event) => {
      updateJsonForEndpoint(event.target.value);
    });

    

    
    updateJsonForEndpoint(document.getElementById('endpoint').value);
    
    const storedApiKey = localStorage.getItem('apiKey');
    if (storedApiKey) {
      document.getElementById('apiKey').value = storedApiKey;
    } else {
      alert('No API key found. Please log in.');
      window.location.href = 'login.html'; 
    }
    
    const apiKey = localStorage.getItem("apiKey");
    const userDashboardLink = document.getElementById("userDashboardLink");
    
    if (apiKey) {
      userDashboardLink.href = `/user-dashboard?apiKey=${apiKey}`;
    } else {
      userDashboardLink.href = "/login.html"; 
    }
    
document.getElementById("logoutButton").addEventListener("click", async () => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  loadingOverlay.style.display = "flex";

  try {
    const res = await fetch("/api/logout", {
      method: "POST",
      credentials: "include",
    });

    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem("apiKey");
      window.location.href = "/login.html";
      return;
    }

    localStorage.removeItem("apiKey");

    setTimeout(() => {
      window.location.href = "/login.html";
    }, 500);
    
  } catch (error) {
    console.error("Logout failed:", error);
    alert("Failed to log out. Please try again.");
    loadingOverlay.style.display = "none";
  }
});



    document.getElementById("previewDevBtn").addEventListener("click", () => {
  sendRequest(true);
});

document.getElementById("generateDevBtn").addEventListener("click", () => {
  sendRequest(false); 
});


async function connectShopify(domain, token) {
        const apiKey = localStorage.getItem('apiKey');

  if (!apiKey) return alert('You must login first.');

  try {
    const res = await fetch('/api/auth/connect-shopify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey
      },
      body: JSON.stringify({ connectedShopDomain: domain, shopifyAccessToken: token }),
        credentials: "include",
    });

    const data = await res.json();
    if (res.ok) {
      alert('Shopify connected!');
    } else {
      alert(data.error || 'Failed to connect Shopify');
    }
  } catch (err) {
    alert('Error connecting Shopify');
  }
}

async function sendRequest(isPreview = false) {
  console.log('Sending request, isPreview =', isPreview);
  const endpoint = document.getElementById("endpoint").value.trim();
  const apiKey = document.getElementById("apiKey").value.trim();
  const jsonInput = document.getElementById("json").value;
  const result = document.getElementById("result");

  if (!endpoint) {
    result.innerText = "Please select an endpoint.";
    return;
  }
  if (!apiKey) {
    result.innerText = "API key is required.";
    return;
  }

  result.innerText = isPreview ? "Generating preview..." : "Generating PDF...";

  let parsedData;
  try {
    parsedData = JSON.parse(jsonInput);
  } catch (parseError) {
    result.innerText = "Invalid JSON input: " + parseError.message;
    return;
  }

  let payload;

  if (parsedData && typeof parsedData === 'object') {
    if ('html' in parsedData) {
    
      payload = {
        html: parsedData.html,
        isPreview
      };
    } else if ('data' in parsedData) {
     
      payload = {
        ...parsedData,
        isPreview
      };
    } else {
      
      payload = {
        data: parsedData,
        isPreview
      };
    }
  } else {
    result.innerText = "Invalid input format.";
    return;
  }

  try {
    const response = await fetch(`/api/${endpoint}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify(payload),
        credentials: "include",
    });

    if (!response.ok) {
      let errorMessage = "PDF request failed.";
      try {
        const errorJson = await response.json();
        errorMessage = errorJson.error || errorMessage;
      } catch {
        const errorText = await response.text();
        errorMessage = errorText || errorMessage;
      }
      throw new Error(errorMessage);
    }

    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);

    if (isPreview) {
      window.open(blobUrl, "_blank");
    } else {
      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = "Generated.pdf";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    result.innerText = "";
  } catch (err) {
    console.error("PDF request error:", err);
    result.innerText = `PDF ${isPreview ? "preview" : "download"} failed: ${err.message}`;
  }
}


    
    fetch('/get-stripe-key')
      .then(response => response.json())
      .then(data => {
        const stripe = Stripe(data.stripePublishableKey);
    
        document.getElementById('payment-button').addEventListener('click', async () => {
          const apiKey = document.getElementById('apiKey').value || localStorage.getItem('apiKey');
          if (!apiKey) {
            alert('Please provide your API key');
            return;
          }
    
          try {
            const response = await fetch('/api/stripe/create-checkout-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                email: "user@example.com", 
                plan: "premium" 
              }),
                credentials: "include",
            });
    
            if (!response.ok) {
              const error = await response.json();
              console.error("Error creating checkout session:", error);
              alert(`Error: ${error.error || "Failed to create checkout session"}`);
              return;
            }
    
            const session = await response.json();
    
            if (!session.id) {
              alert('Error: No session ID returned from backend.');
              console.log(session);
              return;
            }
    
            const { error } = await stripe.redirectToCheckout({ sessionId: session.id });
            if (error) {
              console.log(error);
              alert('Error during checkout');
            }
          } catch (err) {
            console.error("Unexpected error:", err);
            alert('An unexpected error occurred. Please try again.');
          }
        });
      })
      .catch(error => console.error('Error fetching Stripe key:', error));



  


      window.addEventListener("pageshow", () => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  loadingOverlay.style.display = "none";
  console.log("Spinner hidden on page show (e.g., back navigation)");
});


    </script>
</body>
</html>



<style>
 .active {
    background-color: #2563eb; /* Tailwind's bg-blue-600 */
    color: white;
  }
  .friendly-label {
    font-size: 1.25rem;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

</style>


