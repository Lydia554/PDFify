<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"></div>
  </div>

  <!-- Navigation -->
  <nav class="bg-white shadow px-6 py-4 flex justify-between items-center border-b border-gray-200">
    <div class="space-x-4">
      <a href="/api-guide" class="text-blue-600 hover:underline font-medium">ðŸ“„ API Docs</a>
      <a href="/shopify-guide" class="text-blue-600 hover:underline font-medium">ðŸ“„ Shopify Guide</a>
      <a href="/pdf-generator-demo" class="text-blue-600 hover:underline font-medium">ðŸ“„ PDF Generator</a>
    </div>
    <button id="logoutButton" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold px-4 py-2 rounded">Logout</button>
  </nav>

  <!-- Content Wrapper -->
  <main class="max-w-3xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">User Dashboard</h1>

    <!-- User Info -->
    <div id="user-info" class="bg-white shadow rounded p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Your Account</h2>
      <p><strong>Email:</strong> <span id="email">Loading...</span></p>
      <p><strong>API Key:</strong> <span id="apiKey">Loading...</span></p>
      <p><strong>Usage Count:</strong> <span id="usageCount">Loading...</span></p>
      <p><strong>Max Usage:</strong> <span id="maxUsage">Loading...</span></p>
      <p><strong>Premium Status:</strong> <span id="premiumStatus">Loading...</span></p>
    </div>

    <!-- Subscription Management -->
    <div class="bg-white shadow rounded p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Manage Subscription</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="upgradeSubscriptionButton" class="bg-green-500 hover:bg-green-600 text-white font-medium px-4 py-2 rounded w-full">Upgrade to Premium</button>
        <button id="downgradeSubscriptionButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium px-4 py-2 rounded w-full">Downgrade to Free</button>
      </div>
    </div>

    <!-- Shopify Integration -->
    <div class="bg-white shadow rounded p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Shopify Store Integration</h2>
      <p class="mb-2"><strong>Connected Shopify Store:</strong> <span id="connectedShopDomain">None</span></p>
      <label for="shopDomainInput" class="block text-sm font-medium text-gray-700">Shop Domain</label>
      <input id="shopDomainInput" type="text" class="mt-1 mb-4 w-full px-3 py-2 border rounded" placeholder="e.g. mystore.myshopify.com">
      <label for="shopifyAccessToken" class="block text-sm font-medium text-gray-700">Shopify Access Token</label>
      <input id="shopifyAccessToken" type="text" class="mt-1 mb-4 w-full px-3 py-2 border rounded">
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="connectShopifyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded w-full">Connect Shopify Store</button>
        <button id="disconnectShopifyButton" class="bg-pink-500 hover:bg-pink-600 text-white font-medium px-4 py-2 rounded w-full">Disconnect</button>
      </div>
      <p id="shopifyResult" class="mt-4 text-sm font-semibold text-gray-700"></p>
    </div>

    <!-- Update Info -->
    <div class="bg-white shadow rounded p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Update Your Information</h2>
      <form id="updateUserForm">
        <label for="newEmail" class="block text-sm font-medium text-gray-700">New Email</label>
        <input id="newEmail" type="email" class="mt-1 mb-4 w-full px-3 py-2 border rounded" placeholder="Enter new email">

        <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
        <input id="newPassword" type="password" class="mt-1 mb-4 w-full px-3 py-2 border rounded" placeholder="Enter new password">

        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded w-full">Update Info</button>
      </form>
    </div>

    <!-- Delete Account -->
    <div class="bg-white shadow rounded p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Delete Account</h2>
      <button id="deleteAccountButton" class="bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded w-full">Delete Account</button>
      <p id="result" class="mt-4 text-sm font-semibold text-gray-700"></p>
    </div>
  </main>


  
  <script>
    
    const api = axios.create({
      baseURL: "/api",
      timeout: 10000,
    });

    function getApiKey() {
      return new URLSearchParams(window.location.search).get("apiKey") || localStorage.getItem("apiKey");
    }

    api.interceptors.request.use(
      (config) => {
        const apiKey = getApiKey();
        if (apiKey) {
          config.headers.Authorization = `Bearer ${apiKey}`;
        }
        return config;
      },
      (error) => Promise.reject(error)
    );

    api.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response && error.response.status === 401) {
          alert("Session expired or unauthorized. Please log in again.");
          localStorage.removeItem("apiKey");
          window.location.href = "/login.html";
        }
        return Promise.reject(error);
      }
    );

   
    function maskApiKey(key) {
      if (!key) return "";
      return key.slice(0, 4) + "..." + key.slice(-4);
    }


    function displayUserInfo(data) {
      document.getElementById("email").textContent = data.email || "";
      document.getElementById("apiKey").textContent = maskApiKey(data.apiKey || "");
      document.getElementById("usageCount").textContent = data.usageCount || 0;
      document.getElementById("maxUsage").textContent = data.maxUsage || 0;
      document.getElementById("premiumStatus").textContent = data.isPremium ? "Premium" : "Free";
    }

    async function fetchUserData() {
      const apiKey = getApiKey();
      if (!apiKey) {
        document.getElementById("result").textContent = "No API key found. Please log in.";
        window.location.href = "/login.html";
        return;
      }
      try {
        const response = await api.get("/user/usage");
        displayUserInfo(response.data);
        document.getElementById("result").textContent = "";
      } catch (error) {
        console.error("Error fetching user data:", error);
        if (error.response && error.response.status === 404) {
          localStorage.removeItem("apiKey");
          alert("Your account no longer exists. Redirecting to login.");
          window.location.href = "/login.html";
        } else {
          document.getElementById("result").textContent = "Error fetching user data. Please try again later.";
        }
      }
    }

    


    document.querySelectorAll("nav a").forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const targetUrl = event.target.href;
        const loadingOverlay = document.getElementById("loadingOverlay");
        loadingOverlay.style.display = "flex";

        if (!targetUrl) {
          console.error("Invalid target URL");
          loadingOverlay.style.display = "none";
          return;
        }

        setTimeout(() => {
          window.location.href = targetUrl;
        }, 500);
      });
    });

    window.addEventListener("load", () => {
      const loadingOverlay = document.getElementById("loadingOverlay");
      loadingOverlay.style.display = "none";
    });

    window.addEventListener("pageshow", () => {
      const loadingOverlay = document.getElementById("loadingOverlay");
      loadingOverlay.style.display = "none";
    });


    const upgradeBtn = document.getElementById("upgradeSubscriptionButton");
    const downgradeBtn = document.getElementById("downgradeSubscriptionButton");
    const resultMessage = document.getElementById("result");

    async function handleSubscriptionChange(type) {
      const button = type === "upgrade" ? upgradeBtn : downgradeBtn;
      button.disabled = true;
      resultMessage.textContent = "";

      try {
        if (type === "upgrade") {
          const stripeKeyResponse = await api.get("/get-stripe-key");
          const stripe = Stripe(stripeKeyResponse.data.stripePublishableKey);

          const response = await api.post("/stripe/create-checkout-session", {
            email: document.getElementById("email").textContent,
            plan: "premium",
          });

          if (response.data.id) {
            const { error } = await stripe.redirectToCheckout({ sessionId: response.data.id });
            if (error) {
              resultMessage.textContent = "Failed to redirect to Stripe. Please try again.";
            }
          } else {
            resultMessage.textContent = "Failed to create checkout session. Please try again.";
          }
        } else {
          const response = await api.post("/stripe/unsubscribe");
          if (response.status === 200) {
            resultMessage.textContent = response.data.message;
            await fetchUserData();
          }
        }
      } catch (error) {
        console.error(`Failed to ${type === "upgrade" ? "upgrade" : "cancel"} subscription:`, error);
        resultMessage.textContent = `Failed to ${type === "upgrade" ? "upgrade" : "cancel"} subscription. Please try again.`;
      } finally {
        button.disabled = false;
      }
    }

    upgradeBtn.addEventListener("click", () => handleSubscriptionChange("upgrade"));
    downgradeBtn.addEventListener("click", () => handleSubscriptionChange("downgrade"));

    
document.getElementById("logoutButton").addEventListener("click", async () => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  loadingOverlay.style.display = "flex";

  try {
    const res = await fetch("/api/logout", {
      method: "POST",
      credentials: "include", 
    });

    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem("apiKey");
      window.location.href = "/login.html";
      return;
    }

    localStorage.removeItem("apiKey");

    setTimeout(() => {
      window.location.href = "/login.html";
    }, 500);
    
  } catch (error) {
    console.error("Logout failed:", error);
    alert("Failed to log out. Please try again.");
    loadingOverlay.style.display = "none";
  }
});


    
    document.getElementById("updateUserForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const newEmail = document.getElementById("newEmail").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();

      if (!newEmail && !newPassword) {
        resultMessage.textContent = "Please enter a new email or password to update.";
        return;
      }

      try {
        const response = await api.put("/user/update", { email: newEmail, password: newPassword });
        resultMessage.textContent = response.data.message;
        fetchUserData();
      } catch (error) {
        console.error("Error updating user information:", error);
        resultMessage.textContent = "Failed to update information. Please try again.";
      }
    });

  
    document.getElementById("deleteAccountButton").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
        return;
      }

      try {
        const response = await api.delete("/user/delete");
        resultMessage.textContent = response.data.message || "Account deleted.";
        localStorage.removeItem("apiKey");
        setTimeout(() => window.location.href = "/user-creation.html", 2000);
      } catch (error) {
        console.error("Error deleting account:", error);
        resultMessage.textContent = "Failed to delete account. Please try again.";
      }
    });



    // Fetch Shopify connection info and update UI
async function fetchShopifyConnection() {
  try {
    const response = await api.get("/shopify/connection");
    const { connectedShopDomain } = response.data;
    document.getElementById("connectedShopDomain").textContent = connectedShopDomain || "None";
  } catch (error) {
    console.error("Failed to fetch Shopify connection:", error);
    document.getElementById("connectedShopDomain").textContent = "Error fetching data";
  }
}

document.getElementById("connectShopifyButton").addEventListener("click", async () => {
  const shopDomainInput = document.getElementById("shopDomainInput");
  const accessTokenInput = document.getElementById("shopifyAccessToken");

  if (!shopDomainInput || !accessTokenInput) {
    document.getElementById("shopifyResult").textContent = "Missing input elements.";
    return;
  }

  const shopDomain = shopDomainInput.value.trim();
  const accessToken = accessTokenInput.value.trim();

  if (!shopDomain || !accessToken) {
    document.getElementById("shopifyResult").textContent = "Please enter both shop domain and access token.";
    return;
  }

  document.getElementById("connectShopifyButton").disabled = true;
  document.getElementById("shopifyResult").textContent = "";

  try {
    const response = await api.post("/shopify/connect", {
      shopDomain,
      accessToken,
    });

    document.getElementById("shopifyResult").textContent =
      response.data.message || "Shopify store connected!";
    document.getElementById("connectedShopDomain").textContent = shopDomain;
  } catch (error) {
    console.error("Error connecting Shopify store:", error);
    document.getElementById("shopifyResult").textContent = "Failed to connect Shopify store.";
  } finally {
    document.getElementById("connectShopifyButton").disabled = false;
  }
});


document.getElementById("disconnectShopifyButton").addEventListener("click", async () => {
  const resultEl = document.getElementById("shopifyResult");

  try {
    await api.post("/shopify/disconnect");
    resultEl.textContent = "Shopify store disconnected.";
    resultEl.className = "result success";
    resultEl.style.display = "block";
    document.getElementById("shopifyConnectedStatus").textContent = "Not connected.";
  } catch (error) {
    console.error("Error disconnecting Shopify store:", error);
    resultEl.textContent = "Failed to disconnect Shopify store.";
    resultEl.className = "result error";
    resultEl.style.display = "block";
  }
});

// Fetch Shopify connection info on load as well
fetchShopifyConnection();


    fetchUserData();
  </script>



</body>
</html>


  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7fb;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }

    button {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1976d2;
    }

    label {
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 15px;
    }

    #logoutButton {
      background-color: #ff4081;
      padding: 10px 20px;
      font-size: 16px;
      width: auto;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    #logoutButton:hover {
      background-color: #f50057;
    }

    #result {
      margin-top: 15px;
      font-size: 16px;
      color: #333;
      font-weight: bold;
    }

    .api-docs-button,
    .pdf-gen-button {
      display: inline-block;
      margin: 10px 0;
      padding: 10px 16px;
      background-color: #5e72e4;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .api-docs-button:hover {
      background-color: #324cdd;
    }


    @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 20px;
      }

      button {
        font-size: 14px;
        padding: 10px;
      }

      label, input {
        font-size: 14px;
      }
    }



    button {
      border: none;
      border-radius: 4px;
      font-size: 1em;
      margin: 5px 0;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background-color: #bbb !important;
      cursor: not-allowed;
    }
  </style>

